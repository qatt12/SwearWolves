#
#              ⡤⣸⡇⣤⣤⣤⣀⣀⣀⠴⣾⣿⣿⡟⣿⠏⡏⣴⣿⣿⣿⢏⣾⣿⣿⣧⢻⣿⣿⠆⣠          ⡀   
#        ⣠⣶⣿⣿⢳⣿⡇⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢸⣶⣭⣻⢿⢯⣞⡝⣿⣿⣫⢃⣛⣵⣾⣿        ⢀⣾    
#       ⣰⣿⣿⣿⣏⣿⣿⡇⣿⣿⣿⣿⣿⣿⣿⡿⣟⣯⣷⣾⢸⣿⣿⣿⣷⣿⡏⠁⣿⣿⡀⢸⣿⣿⣿⣿        ⣼⣿    
#      ⣼⣿⣿⣿⡟⣼⣿⣿⡇⣿⣿⣿⣿⡿⣟⣽⣾⣿⣿⣿⣿⡏⣿⣿⣿⣿⣿⣷⡴⠿⢟⣛⣭⣭⣭⣭⣝⣀      ⢠⣿⣿⡀   
#     ⣸⣿⣿⣿⣿⢱⣿⣿⣿⡇⣿⣿⡿⣫⣾⣿⣿⡿⣻⣵⣶⣿⣿⣷⣶⣶⣶⣶⣶⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣦⡀   ⢸⣿⣿⡇   
#    ⢰⣿⣿⣿⣿⡟⣾⣿⣿⣿⣧⠹⣫⣾⣿⣿⣿⣫⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣆  ⢸⣿⣿⣿   
#    ⣿⣿⣿⣿⣿⡇⣿⣿⣿⣿⣿⣎⢿⣿⣿⣿⣳⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣆ ⢸⣿⣿⣿⡇  
#   ⢸⣿⣿⣿⣿⣿⢹⣿⣿⣿⣿⣿⣿⣦⡻⣿⢧⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢹⣿⣿⣿⣿⣿⣿⣿⣿⣇⢿⣿⣿⣿⣿  
#   ⣾⣿⣿⣿⣿⣿⢸⣿⣿⣿⣿⣿⣿⣿⣿⡆⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠸⣿⣿⣿⣿⣿⣿⣿⠿⣿⡎⣿⣿⣿⣿⡇ 
#   ⣿⣿⣿⣿⣿⣿⡜⣿⣿⣿⣿⣿⣿⣿⡿⣹⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡏⣿⣿⣿⣿⣿⣿⣿⣿⣿⢀⢻⣿⣿⣿⡿⠛⣡⣾⣿⣿⡜⣿⣿⣿⣇ 
#  ⢸⣿⣿⣿⣿⣿⣿⡇⣿⣿⣿⣿⣿⣿⢟⣵⣟⣼⣿⣟⠻⣿⣿⣿⣿⣿⣿⣿⢁⢿⣿⣿⣿⣿⣿⣿⣿⡿⣼⣎⢿⠿⢋⣴⣿⣿⣿⣿⣿⣷⡹⣿⣿⣿ 
#  ⢸⣿⣿⣿⣿⣿⣿⣧⢻⣿⣿⣿⣟⣑⣚⢍⣾⣿⣿⣿⣷⣦⣙⠻⣿⣿⣿⢧⣿⡸⣿⣿⣿⣿⣿⣿⣿⢇⣿⠟⣀⢶⣿⣿⣿⣿⣿⣿⣿⣿⣿⣜⠿⡟ 
#  ⢸⣿⣿⣿⣿⣿⣿⣿⡘⣿⣿⣿⡿⢟⣵⣿⣿⣿⣿⣿⣿⣿⣿⣷⣦⡙⠣⣿⣿⣧⢻⣿⣿⣿⣿⣿⠏⠜⡡⠞⠛⠃⠙⠿⠿⣿⣿⣿⢿⣿⣿⠿⣫⠇ 
#  ⠈⣿⣿⣿⣿⣿⣿⡟⣷⢜⣫⣽⢞⣿⣿⣿⣿⣿⣿⣿⣿⡿⣿⣿⠟⠵⠷⢬⡙⢿⡜⣿⢹⣿⣿⢏⣴⠊⣠⠶⠿⢷⣦⣄⠈⢙⣛⡛⣃⣐⣶⣾⠏  
#   ⣿⣿⣿⣿⣿⣿⣧⣿⣿⣔⣼⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠂⣠⡤⠴⠦⢤⣙⣿⣧⠛⣼⠟⣡⣾⣿⣾⣿⡗  ⠹⣿⣆⠈⣙⡇⣿⣿⡿⠋   
#   ⢸⣿⣿⣿⣿⣿⣿⢉⣾⣿⣿⣿⣿⣿⣿⣿⡿⠿⠟⠃⢠⣾⣿⡷   ⠻⣿⣿⣴⣷⣿⣿⣿⣿⡇⠉    ⢻⣿⡆⢿⣇⠛⠉     
#   ⠘⣿⣿⣿⣿⣿⣿⢸⣿⣿⣿⣿⣿⣶⣤⣲⣶⣾⠿⢀⣿⣿⠙⠁   ⡀⢻⣿⣿⣿⣿⣿⣿⣿⣧⠰⣄⣀⣠⡇⢸⣿⣧⢺⣿⡄      
#    ⣿⣿⣿⣿⣿⣿⡏⣿⣿⣿⣿⣿⣿⣿⢻⣿⣿⡇⢸⣿⣷⠠⣄⡀⢀⣰⡇⣸⣿⣿⣿⣿⣿⣿⣿⣿⣦⡙⠿⠿⣡⣿⢿⣿⡏⣿⣷⡀     
#    ⢻⣿⣿⣿⣿⣿⣿⣹⣿⣿⣿⣿⢏⣽⢸⣿⣿⣧⠘⣿⣿⣆⠙⠿⠿⢟⣵⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣶⣶⢲⢮⡿⣽⣷⣿⣿⣷     
#    ⣸⣿⣿⣿⣿⣿⣿⣧⢿⣿⣿⡏⣾⣯⡍⣿⣿⣿⡼⣯⣟⣛⣻⢶⢼⣟⣿⣿⣿⣿⣿⣿⣿⠿⠿⣿⣿⣿⠿⣫⣏⣾⢳⢳⢇⣿⣿⡿⡇    
#   ⣿⣟⣿⣿⣿⣿⣿⣿⣎⢿⣿⡇⣿⡿⡇⢻⣿⣿⣷⣝⠳⠷⢯⢏⣟⣾⡏⣙⣛⢛⣋⣥⣶⣶⣦⣄⡀⠐⠆⣿⣿⣿⣟⣫⢾⣿⣿⡇⠃    
#   ⡸⠋⣼⣿⣿⣿⣿⣿⣿⣿⣯⢿⣿⡜⠋⢀⡌⣿⣿⣿⣮⡩⢾⣯⣾⣿⣿⡇⣧⣣⣾⣿⣿⣿⣿⣿⣿⣿⣦ ⣿⣿⣿⣿⢏⣿⣿⠟⠁     
#    ⣸⣿⣿⣿⣿⣿⣿⣿⣿⢟⣽⣿⠃ ⣾⣿⡘⢿⣿⣿⣿⣷⡮⣹⣿⣿⡇⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⢱⣿⣿⣿⣋⠚⣩⡵⣸      
#   ⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣶⢦⣇ ⣿⣿⣿⣤⠓⠈⢽⣭⣾⣿⣿⣿⣷⡘⣿⣿⣿⣿⣿⣿⣿⣿⠟⣡⣿⣿⡿⢛⡁⠘⢛⣱⡇      
#   ⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡱⢿⣿⣦⡘⠿⠿⢟⣱⣶⣤⣽⡻⢿⣿⣿⣿⣿⣮⣙⠻⠿⠿⠟⣋⣡⣾⠿⢛⣥⣶⣿⣧⡀ ⠛       
#  ⢰⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣾⣿⣶⣻⣿⣿⡏⠛⠿⡟⣫⠁⠸⢭⣝⣛⣛⣛⠿⡟⠛⢋⣭⣥⣶⣾⡟⠛⠋⢉⣁ 
#  ⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢛⣛⠓⠉⠛⠇⣀⣤⠶⢎⠠⠇ ⣀⠈⢉⡉⠉⢀⡀⠰ ⠉⠉⠉⠉
#  ⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡎⡳⠂ ⣠⡾⣫⣶⣿⣿⣷⣦⣄⣉⣀⣈⣁⣀⣠⣤⣾⣶⣦⣄⡀ 
#  ⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢟⠋⡱⠁ ⡰⡟⠑⠿⠿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿


import pygame, config
from misc import controller_list as c_list
from misc import player_list as p_list
pygame.init()

game_window = pygame.display.set_mode(config.screen_size)
clock = pygame.time.Clock()

class game_state():
    def __init__(self):
        self.state_number = 0
        self.state_name = "closed"

class screen_handler():
    def __init__(self, display):
        print("display rect is : ", display.get_rect())
        self.disp = pygame.Surface(config.screen_size)
        self.size = config.screen_size
        self.menus = pygame.sprite.Group()
        self.player_one = None
        self.player_index = 0
        self.ordered_list_of_player_HANDLERS = []
        self.current_room = None
        self.game_state = "start_menu"

    def update(self, *args, **kwargs):
        if 'opened_menus' in kwargs:
            self.menus.add(kwargs['opened_menus'])
            print("added new menu: ")
            self.disp.blit(kwargs['opened_menus'].image, (0, 0))
        if 'closed_menus' in kwargs:
            self.menus.remove(kwargs['closed_menus'])
        if 'player_one' in kwargs:
            self.player_one = (kwargs['player_one'])
            self.player_index = 1
            self.ordered_list_of_player_HANDLERS = [self.player_one]
        if 'next_player' in kwargs:
            self.ordered_list_of_player_HANDLERS.append(kwargs['next_player'])
            self.player_index += 1
        if 'room' in kwargs:
            self.current_room = kwargs['room']

        self.menus.update()
        if self.current_room is not None:
            self.current_room.update()

    def draw(self, display, scroll=(0, 0)):
        pygame.draw.rect(self.disp, config.black, ((0, 0), config.screen_size))
        if self.game_state == 'game_loop':
            if self.current_room is not None:
                self.current_room.draw_contents(self.disp)
                #self.current_room.draw_contents(display)

            for each in self.ordered_list_of_player_HANDLERS:
                each.draw(self.disp)
                #each.draw(display)

        display.blit(self.disp, scroll)
        self.menus.draw(display)
        pygame.display.update()


running = True
start_loop = True
player_select_loop = True
game_loop = True

import menu

cntrllr = c_list()

start_menu = menu.menu(game_window.get_rect())
screen = screen_handler(game_window)
screen.update(opened_menus=start_menu)
player_one_HANDLER = None

while(start_loop and running):
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    if cntrllr.is_p1_ready():
        player_one_HANDLER = cntrllr.get_p1()
        print("player one handler is of type: ", type(player_one_HANDLER))
        print("player one handler's controller is of type: ", type(player_one_HANDLER.controller))
        screen.update(player_one=player_one_HANDLER, closed_menus=start_menu)
        start_loop = False
        start_menu.kill()

    cntrllr.update()

    screen.update()
    screen.draw(game_window)

    clock.tick(config.fps)
    pygame.display.update()
    pygame.event.pump()
    pygame.time.wait(0)

game_window.fill((0, 0, 0))

import spells

unlocked_books = [spells.book_of_fire(), spells.book_of_acid(), spells.book_of_ice(), spells.book_of_light()]

player_num = 1
p1_char_select = menu.player_select_menu(1, unlocked_books)
p2_char_select = menu.player_select_menu(2, unlocked_books)
p3_char_select = menu.player_select_menu(3, unlocked_books)
p4_char_select = menu.player_select_menu(4, unlocked_books)

screen.update(opened_menus=p1_char_select)
print(screen)
ready_players = 0
player_one_HANDLER.attach(menu=p1_char_select)
banned_list = []

while(player_select_loop and running):
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    screen.game_state = "char_select_loop"

    if ready_players >= player_num:
        player_select_loop = False

    cntrllr.update()
    if cntrllr.is_next_ready():
        print("found next player; player: ", player_num)
        if player_num == 1:
            player_num = 2
            player_two_HANDLER = cntrllr.get_next_player()
            player_two_HANDLER.attach(menu=p2_char_select)
            screen.update(next_player=player_two_HANDLER, opened_menus=p2_char_select)
        elif player_num == 2:
            player_num = 3
            player_three_HANDLER = cntrllr.get_next_player()
            player_three_HANDLER.attach(menu=p3_char_select)
            screen.update(next_player=player_three_HANDLER, opened_menus=p3_char_select)
        elif player_num == 3:
            player_num = 4
            player_four_HANDLER = cntrllr.get_next_player()
            player_four_HANDLER.attach(menu=p4_char_select)
            screen.update(next_player=player_four_HANDLER, opened_menus=p4_char_select)

    screen.update()
    screen.draw(game_window)
    for each in screen.menus:
        pick = each.is_ready()
        if pick != -1 and pick not in banned_list:
            banned_list.append(pick)
            ready_players += 1

    for each in screen.ordered_list_of_player_HANDLERS:
        each.update_menu()

    screen.draw(game_window)

    clock.tick(config.fps)
    pygame.display.update()
    pygame.event.pump()
    pygame.time.wait(0)

player_sprites = pygame.sprite.Group()

screen.update(closed_menus=(p1_char_select, p2_char_select, p3_char_select, p4_char_select))

game_window.fill((0, 0, 0))
import room, player
# scope tomfoolery
plyr = player.multiplayer
for each in screen.ordered_list_of_player_HANDLERS:
    each.begin_game(plyr, (0, 0))

#first_time_start = pygame.event.Event(FIRST_GAME, )
hub = room.hub_room(game_window)
screen.update(room=hub)
scroll = (0, 0)

while(game_loop and running):
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    screen.game_state = "game_loop"

    for each in screen.ordered_list_of_player_HANDLERS:
        each.update()

    screen.draw(game_window, scroll)


    clock.tick(config.fps)
    pygame.display.update()
    pygame.event.pump()
    pygame.time.wait(0)
