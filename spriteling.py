#                                                               ..---..._
#                                                         ..--""         "-.
#                                                    ..-"""                 ".
#                                                ..-""                        "
#                                             .-"
#                                          .-"      ... -_
#                                      .="   _..-" F   .-"-.....___-..
#                                      "L_ _-'    ."  j"  .-":   /"-._ "-
#                                         "      :  ."  j"  :   :    |"" ".
#                                   ......---------"""""""""""-:_     |   |\
#                         ...---""""                             -.   f   | "
#                 ...---""       . ..----""""""""..                ".-... f  ".
#          ..---"""       ..---""""""""-..--"""""""""^^::            |. "-.    .
#      .--"           .mm::::::::::::::::::::::::::...  ""L           |x   ".
#    -"             mm;;;;;;;;;;XXXXXXXXXXXXX:::::::::::.. |           |x.   -
#  xF        -._ .mF;;;;;;XXXXXXXXXXXXXXXXXXXXXXXXXX:::::::|            |X:.  "
# j         |   j;;;;;XXX#############################::::::|            XX::::
# |          |.#;::XXX##################################::::|            |XX:::
# |          j#::XXX#######################################::             XXX::
# |         .#:XXX###########################################             |XX::
# |         #XXX##############################XX############Fl             XXX:
# |        .XXX###################XX#######X##XXX###########Fl             lXX:
#  |       #XX##################XXX######XXXXXXX###########F j             lXXX
#  |       #X#########X#X#####XXX#######XXXXXX#######XXX##F  jl            XXXX
#  |       #X#######XX#"  V###XX#' ####XXXXXX##F"T##XXXXXX.  V   /  .    .#XXXX
#   |       #########"     V#XX#'  "####XXXX##.---.##XXXXXX.    /  /  / .##XXXX
#   |       "######X' .--"" "V##L   #####XXX#"      "###XXXX. ."  /  / .###XXXX
#   |         #####X "   .m###m##L   ####XX#      m###m"###XX#   /  / .#####XXX
#    |         "###X   .mF""   "y     #####     mX"   "Y#"^####X   / .######XXX
#    |           "T#   #"        #     ####    X"       "F""###XX"###########XX
#    |             L  d"     dXX  xm   "^##L mx     dXX  YL-"##XX"S""##########
#     |            xL J     Xd%    T      ""  T    XdX    L. "##XS.f |#########
#     |             BL      X## X                  X## X      T#SS"  |#########
#     |              #L     X%##X                  X%##X|     j#SSS /##########
#      |              #L  ._ TXXX-"           "-._  XXXF.-    ###SS\###########
#      |              ##   """""                  """"""      ##DS.\###########
#      |              TF                                      ##BBS.T#########F
#       |             #L           ---                        ###BBS.T########'
#       |            '##            ""                     jL|###BSSS.T#######
#        |          '####             ______              .:#|##WWBBBSS.T####F
#       J L        '######.            \___/            _c::#|###WWWBSSS|####
#      J ;;       '########m            \_/            c:::'#|###WWWBBSS.T##"
#     J ;;;L      :########.:m.          _          _cf:::'.L|####WWWWSSS|#"
#   .J ;;;;B      ########B....:m..             _,c%%%:::'...L####WWWBBSSj
#  x  ;;;;dB      #######BB.......##m...___..cc%%%%%::::'....|#####WWBBDS.|
# " ;;;;;ABB#     #######BB........##j%%%%%%%%%%%%%%:::'..... #####WWWWDDS|
# .;;;;;dBBB#     #######BB.........%%%%%%%%%%%%%%%:::'...   j####WWWWWBDF
# ;;;;;BBB####    ######BBB.........%%%%%%%%%%%%%%:::'..     #####WWWWWWS
# ;;;;dBBB####    ######BBB..........^%%%%%%%%%%:::"         #####WWWWWWB
# ;;;:BBB######   X#####BBB"..........."^YYYYY::"            #####WWWWWWW
# ;;.BB#########  X######BBB........:''                      #####WWWWWWW
# ;;BB##########L X######BBB.......mmmm..                 ..x#####WWWWWWB.
# ;dBB########### X#######BB.....        "-._           x""  #####WWWWWWBL
# ;BBB###########L X######BB...              "-              ######WWWWBBBL
# BBB#############. ######BBB.                                #####WWWWBBBB
# BBB############## X#####BBB                                 #####WWWWWBBB
# BBB############### T#####BB                                  #####WWWBBB     :
# BB################# T###BBP                                   #####WWBB"    .#
# BB##################..W##P                                      ###BBB"    .##
# BB###################..l                                         "WW"      ###
# BB####################j ___                                        " l    j###
# BBB##################J_-   """-..             ':::'   .-""""""""""-.  l  .####
# BBB######B##########J########    "-.           ::'  -" ..mmm####mm.."-.< #####
# MCL-5/7/88 BBB#####J############    "-_        :|  " .###############mmLlR####
# BBBBBBBBBBBBBBB###/         #######    -.     .:| ".#####F^^^P^^"""^^^Y#lT####
# BBBBBBBBBBBBBBBBBj|####mm        ######xx-...:::|" ###f      .....      "#T###
# BBBBBBBBBBBBBBBBjj##########mm..           ":::."j##F  .mm#########mmm.. Yj###
# BBBBBBBBBBBBBBBB|^WWWSRR############mmmmm xx """mjF.mm####################j###
# BBBBBBBBBBBBBBBB|                      ######mmmmmm#######################j###
# BBBBBBBBBBBBBBBBY#m...   ..mmm##########PPPPP#####m..                    lj###
# BBBBBBBBBBBBBBBBB2##############^^""     ..umF^^^Tx ^##mmmm........mmmmmmlj###
# BBBBBBBBBBBBBBBBBJT######^^^""     .mm##PPPF"...."m.  "^^###############lj####
# BBBBBBBBBBBBBBBBB##^L         .mmm###PPP............"m..    """"^^^^^"" lj####
# BBBBBBBBBBBBBBBB#####Y#mmx#########P.................."^:muuuummmmmm###^.#####
# BBBBBBBBBBBBBBBB#####::Y##mPPPPF^".......|.............. ""^^######^^"...#####
# BBBBBBBBBBBBBB########..................F............      \     ........#####
# BBBBBBBBBBBBB#########.................|..........          :       ....l#####
# BBBBBBBBBBBB###########...............F.........             \        ..######
# BBBBBBBBBBB#############.............|........                :         dA####
# BBBBBBBBBB##############.....................                           kM####
# BBBBBBBBB################..................                             k#####
# BBBBBBB##################................                               k#####
# BBBBB#####################.............                                 t#####
# BB########################............                                  "E####
# B########################F............                           .       "####
# #########################............'      |                    ..       "L##
# ########################F............                           ...        "L#
# #######################F............'                           .....       "#
# ######################F.............                           .......       "
# #####################$..............                         .........
# #####################lmmm.............                      ...........   ..m#
# ####################j########mmmm.............            ......mmmmmm########
# ###################j###::::;:::::########mmmmmmm##############################
# ##################j:::::::;:::::::;;::##############################^^^""""
# ##################.mm:::mmm######mmmm:::' ^^^^^^""#######^^""""
# #################F...^m::;::################mmm  .mm"""
# #################.......m;::::::::::::#########^"
# ################F.........###mmm::::;' .##^"""
#  ###############F...........:#######m.m#"
#    #############..............':####
#      ##########F............mm^""
#        ########..........m^""
#           #####.......%^"
#              #.....x"
#              |.x""
#             .-"
#           .-
#         .-
#       .-
#      -
#    -"
#  -"
# "
#                                                                              x
#                                                                            xx
#                                                                          xx
#                                                                      xxx"
#                                                                  xxx"
#                                                            .xxxx"
#                                                     ___xxx""
#                                              .xxxx""....F
#                 """"mmxxxxx          ___xxx^^^..........'
#                    .xx^^^^YYYY###xxx^^.................|
#                 .xx^"        #######x..................|
#              .xx"          ###########mx..............f
#            .x^            ##############xx............|
#           j"             ##############    x..........;
# .........#              ############       #x.........|
# x.......j"              ##########       ####x.......f
#  xxx....#..            ########        #######x......|
#    xxxx.#....         #######        ##########x.....|
#       xxx......       #####         #########   x....|
#          xxx......    ###          #######      #m...|
#            xxx......  ##           ######      ####..|
#              xxx......#.          #####       ######m|
#                xxxx.......        ###        #######Fx
#                    xxx......      #         j#####    m
#                       xx......              ####      Jxm
#                        xxx......           ####      j###Km
#                           xxx.....         ###      j####F  m
#                              xx......       #       ###F    .m
#                                xxx ....            j##F    .###m
#                                m..xx.....          ##F    j#####K^mm.
#                                 m...xx......       ##     #####F    ####mm
#                                 m .....x......     F     j####F    ########
#                                  m  ......x.....         ###F    J##########
#                                  "m  ........x....      .#F     #########^^|
#                                   "......mmF^^^x....    ##     ######      |
#                                    lL..jF        x.... .F      ####       |
#                                    lTLJF           x....      ####        |
#                                    l::|.            "....    j###       ##
#                                     l....            L....   ###F     x##
#                                      l....       ..m##L...   ##F     j###
#                                      l:...        #####L...  #F     j####
#                                       l....    ####     ...        #####
#                                       "....              ...       ####F |
#                                        l....              ...     j###F  |
#                                         #...               ....   ###F    |
#                                         "#..              .jL.... ##F     |
#                                          ##.            .m###L....#F      |
#                                          "##        ..mm###### ....       |
#                                           |                   |...        |
#                                           k                    |...       |
#                                           l                    |...       k
#                                            k                 .m#L...     Jk
#                                            ##            ..mm####L...     k
#                                            ###         d########' L....   |
#                                            l                   |   "-.__-"
#                                            l                   |
#                                            l                  j#
#                                            :                 j##
#                                             k               j##'
#                                             l            .m###k
#                                             l           ###^^"|
#                                             |                 |
#                                             j               .##
#                                             |              ######
#                                             |==          ##### ####
#                                            .k          #####"   ####
#                                            l         #####^     ####
#                                            l       ###         ####'
#                                            !                 m###F
#                                            |               ######
#                                            |           mm##m###'
#                                            |.       m########F
#                                            |.    m#######F" #
#                                            d.   ###        #
#                                           |..             .'
#                                           |..             |
#                                            k..           :
#                                            \...          F
#                                             |...        #d
#                                             |...       ###
#                                              L...     ####.
#                                              |...    j### |
#                                               L...   ###  |
#                                               T...  j##    k
#                                                \... ##     |
#                                                  \...      . MCL
#                                                    "^-____-
#
#
#
# contains the inheritance structure and universal methods for spritelings, a class derived from pygame's sprite/group
# class.
#  this outlines how the various creatures and objects will relate to each other, and guarantees that certain derived
# classes will still have some version of a widely used function, even if they themselves don't really use it
# (ex: give everything a move function even if its a stationary object. thus if main tries to make a floor tile move,
# the game doesn't crash).
# also of importance, this allows the calling of isinstance() to help figure out how something should react to hitbox
# collision.

# note that this class hierarchy is tentative, and subject to potentially heavy overloading. It may not necessarily
# make a ton of sense to have things laid out this way, but......
# almost everything here is subject to being renamed or altered in some way.

import pygame, config, events, collections
from events import event_maker

event_maker.make_entry('log', 'spriteling loaded', 'spritelings.py has been loaded', 'spriteling')

placeholder = pygame.image.load('baddies\loogloog.png').convert_alpha()
event_maker.make_entry('log', 'spriteling loaded', 'spritelings.py has been loaded', 'spriteling')

# the use of multiple hitbox is currently deprecated, cause its expensive and complicated, and makes all my code look
# like a twisted hell of for loops
def collide_hitbox(spritelingA, spritelingB):
    return pygame.Rect.colliderect(spritelingA.hitbox.rect, spritelingB.hitbox.rect)

# the common ancestor of all sprite-type classes. Provides universal methods and a core constructor that derived classes
# can use. also, by deriving everything from this, I don't have to type out pygame.sprite.Sprite as many times
class spriteling(pygame.sprite.Sprite):
    tracking_num = 0

    def __init__(self, *args, **kwargs):
        super().__init__()

        self.t_num = spriteling.track_next()
        #### new update: spriteling now takes kwargs, to make calling it less of a pain in the ass
        # this most basal constructor takes an image and a location, assigns the image to the sprite, builds a rectangle
        # from the image, moves the rectangle to the location, then builds a hitbox the same size as the rect, and
        # places it directly on top of the rect
        if 'image' in kwargs:
            self.image = kwargs['image']
        else:
            self.image = placeholder
        self.rect = self.image.get_rect()
        if 'loc' in kwargs:
            self.loc = kwargs['loc']
            self.rect.center = self.loc

        if 'name' in kwargs:
            self.name = kwargs['name']
        else:
            self.name = 'trashboat'

        # a traits keyword, for passing specific named traits to the spriteling. These can be looked up later via a
        # look_for method
        if 'traits' in kwargs:
            self.traits = kwargs['traits']
        else:
            self.traits = ()

        self.activity_state = {}

        self.hp = 1000
        self.cond_queue = []
        self.dmg_mult = {'dmg':1}
        self.immune = []

        # determines how fast and in which direction the spriteling will move in the current frame. update() will
        # perform the rect.move_ip using this
        self.velocity = (0, 0)
        self.move_mult = (1, 1)

        # not sure I we should make all/most spritelings have only one hitbox by default, and just create a subclass
        # with extra
        if 'hitbox' in kwargs:
            self.hitbox = hitbox(self, rect=kwargs['hitbox'])
        else:
            self.hitbox = hitbox(self, rect=self.rect)
        #self.hitboxes = pygame.sprite.Group(self.hitbox)

    def __str__(self):
        message = events.entry('error', "spriteling's __str__",
                               "assessing return type of spriteling's conversion to string", 'spriteling')
        ret = str(self.t_num)
        message.modify(log_entry="successfully appended the tracking number", ret=ret)
        ret += str(type(self))\

        ret += self.name \
        ret += "rect/hitbox: " + str(self.rect) + '/' + str(self.hitbox)
        event_maker.send_entry(message, True, True)
        assert (isinstance(ret, str)), "you fucked up"
        return "NULLLLLLL"

    def update(self, *args, **kwargs):
        # movement stuff. concerns movement from controller input, getting hit with shit, etc
        self.move(**kwargs)
        self.rect.move_ip(self.velocity)
        self.hitbox.update()

    def draw(self, disp, boxes=False):
        disp.blit(self.image, self.rect)
        if boxes:
            self.draw_boxes(disp)

    def draw_boxes(self, disp):
        pygame.draw.rect(disp, config.green, self.rect, 4)
        #for each in self.hitboxes:
        #    pygame.draw.rect(disp, config.red, each.rect, 4)
        pygame.draw.rect(disp, config.red, self.hitbox.rect, 4)

    # minimize use of this; most of its functionality is being taken over by update
    def move(self, **kwargs):
        message = events.entry('trace', 'moving', 'calling move() from spriteling', 'spriteling',
                               'move', 'movement', 'spriteling',
                               inst_src=self, obj_src=spriteling, old_vel=self.velocity, old_rect=self.rect)
        xvel, yvel = 0, 0
        if 'vel' in kwargs:
            xvel, yvel = kwargs['vel'][0], kwargs['vel'][1]
            message.modify(direct_vel=(xvel, yvel))
        if 'move' in kwargs:
            xvel = xvel + (self.move_mult[0] * kwargs['move'][0])
            yvel = yvel + (self.move_mult[1] * kwargs['move'][1])
            message.modify(ext_desc='; voluntary movement', move_vel=(xvel, yvel))
        if 'knockback' in kwargs:
            self.rect.move_ip(kwargs['knockback'][0], kwargs['knockback'][1])
        if 'walls' in kwargs:
            message.modify(new_desc='collided w/ walls', walls=kwargs['walls'])
            for wall in kwargs['walls']:
                # some creative tomfoolery with rectangles and clipping
                # temp is the rectangle of overlap between the hitbox of the offending sprite and the hitbox of the wall
                temp = self.hitbox.rect.clip(wall.hitbox.rect)
                # before forcing a move either up or down, we need to see if our centerx is between the left and right
                # bounds of the wall we've hit. if it is, then this is a top or bottom collision
                if wall.hitbox.rect.left < self.rect.centerx < wall.hitbox.rect.right:
                    # if temp's centery is above our won centery, then the wall we are touching is above us, and we will
                    # need to move downwards (positive y) by an amount equal to the height of temp
                    if temp.centery < self.hitbox.rect.centery:
                        # move our own rect downwards
                        self.rect.move_ip(0, temp.height)
                    # basically the same as above, but now temp's height is negative, to reflect that we're moving
                    # upwards
                    elif temp.centery > self.hitbox.rect.centery:
                        self.rect.move_ip(0, -temp.height)
                if wall.hitbox.rect.bottom > self.rect.centery > wall.hitbox.rect.top:
                    if temp.centerx > self.hitbox.rect.centerx:
                        self.rect.move_ip(-temp.width, 0)
                    elif temp.centerx < self.hitbox.rect.centerx:
                        self.rect.move_ip(temp.width, 0)
                self.hitbox.update()

        if 'bound_rect' in kwargs:
            self.rect.clamp_ip(kwargs['bound_rect'])
        if 'to' in kwargs:
            self.rect.center = kwargs['to']
        if 'shift' in kwargs:
            self.rect.move_ip(kwargs['shift'])
            self.hitbox.rect.move_ip(kwargs['shift'])
        event_maker.send_entry(message, False, False)
        self.velocity = (xvel, yvel)

    # a blank placeholder method for testing targeted spells; may soon become the primary way for sprites to interact
    def affect(self):
        pass

    # a basic function that is called by the associated handler to extract important data from the spriteling, as well
    # as by anything that has to send data to the handler (this is achieved by having the sender call this method to
    # place its data in the spriteling. then, when the handler for that spriteling calls this function, it will receive
    # the sender's message/data)
    def send_to_handler(self, *args):
        for each in args:
            self.cond_queue.append(each)
        return self.cond_queue

    def check_collide(self, target):
        return pygame.Rect.colliderect(self.hitbox.rect, target.hitbox.rect)

    @classmethod
    def track_next(cls):
        cls.tracking_num +=1
        return cls.tracking_num


# basic hitbox class. Essentially just a slightly fancier rect, that automagically maintains its position relative to
# its host (assuming you update it as frequently as you update the host)
class hitbox(pygame.sprite.Sprite):
    def __init__(self, subj, **kwargs):
        super().__init__()
        self.host = subj
        # if a rect is already specified in the constructor, it copies and uses that one
        if 'rect' in kwargs:
            self.rect = pygame.Rect.copy(kwargs['rect'])
        # if no rect is provided, it copies the rect of its host
        else:
            self.rect = pygame.Rect.copy(self.host.rect)
        # the rect scales to the provided x and y proportions
        if 'scale_x' in kwargs:
            xscale = kwargs['scale_x']
        else:
            xscale = 1
        if 'scale_y' in kwargs:
            yscale = kwargs['scale_y']
        else:
            yscale = 1

        self.rect.inflate_ip(xscale, yscale)

        if 'center' in kwargs:
            self.rect.center = kwargs['center']
        if 'left_side' in kwargs:
            self.rect.left = kwargs['left_side']
        if 'right_side' in kwargs:
            self.rect.right = kwargs['right_side']
        if 'bottom_side' in kwargs:
            self.rect.bottom = kwargs['bottom_side']
        if 'top_side' in kwargs:
            self.rect.top = kwargs['top_side']

    def __str__(self):
        ret = "host: " + self.host.name + "| " + "Rect: " + str(self.rect)

    # the ever crucial update method. By default, it just adjusts the hitbox to be centered on the host
    def update(self, **kwargs):
        self.rect.center = self.host.rect.center
        # everything has their hitbox centered by default?
        if 'center' in kwargs:
            self.rect.center = kwargs['center']
        if 'left_side' in kwargs:
            self.rect.left = kwargs['left_side']
        if 'right_side' in kwargs:
            self.rect.right = kwargs['right_side']
        if 'bottom_side' in kwargs:
            self.rect.bottom = kwargs['bottom_side']
        if 'top_side' in kwargs:
            self.rect.top = kwargs['top_side']

    # hitbox level collision detection
    def collide_hitbox(self, spritelingB):
        return pygame.Rect.colliderect(self.rect, spritelingB.hitbox)


# this feels awkward, and I may not use this syntax to handle sprite interaction
class effect():
    num_effect = 0

    def __init__(self, type_word, duration, intensity=1, proc_chance=1, *args, **kwargs):
        print("making a new effect")
        self.type_string = type_word
        self.special = []

        try:
            assert (isinstance(intensity, int)), "intensity should be an integer;"
        except AssertionError:
            print(str(intensity), "must be a *arg, assigning it as such")
            self.special.append(intensity)
            self.intensity = 0
        else:
            self.intensity = intensity

        self.proc_chance = proc_chance
        for each in args:
            self.special.append(each)
        self.key_effects = {}
        for key in kwargs:
            self.key_effects[key] = kwargs[key]

        if duration[0] == 'sec':
            self.duration = duration[1] * config.fps
        elif duration[0] == 'frames':
            self.duration = duration[1]
        try:
            assert (isinstance(duration[0], str)), 'improper duration syntax; need either frames or seconds'
        except AssertionError:
            print(AssertionError, "assigning default duration of 1 (frame)")
            self.duration = 1
        effect.tick_tracker()

    def __call__(self, target, *args, **kwargs):
        pass

    def __str__(self):
        ret = str('Effect #' + str(effect.get_tracker()) + ':\n\t Type: ' + self.type_string + "; Intensity: " + str(self.intensity) + '; Dur: ' +
                   str(self.duration) + "; Proc Chance: " + str(self.proc_chance) + "\n\tSpecial:")
        for each in self.special:
            try:
                assert (isinstance(each, str)), "each is not a string"
            except AssertionError:
                print(AssertionError)
                ret += str(each)
            except:
                ret = ret + each
        ret += '\n'
        return ret

    @classmethod
    def tick_tracker(cls):
        cls.num_effect +=1

    @classmethod
    def get_tracker(cls):
        return cls.num_effect
